<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sprint Dynasty MVP</title>
<style>
  body { margin:0; background:#1b1f2a; font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; }
  .wrap { display:flex; justify-content:center; padding:18px; }
  canvas { background:#0f2a4d; border-radius:16px; box-shadow: 0 10px 30px rgba(0,0,0,.45); }
  .hud {
    max-width:1000px; margin:0 auto; color:#eaf2ff; padding:0 18px 18px;
    display:flex; gap:10px; flex-wrap:wrap; align-items:stretch;
  }
  .card {
    background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.10); border-radius:14px;
    padding:10px 12px; display:flex; gap:10px; align-items:center;
    backdrop-filter: blur(6px);
  }
  .grow { flex: 1 1 420px; }
  .col { display:flex; flex-direction:column; gap:8px; min-width: 240px; }
  button {
    appearance:none; border:0; border-radius:14px; padding:10px 14px;
    background:#ffd400; color:#111; font-weight:900; cursor:pointer;
  }
  button.secondary { background: rgba(255,255,255,.14); color:#eaf2ff; border:1px solid rgba(255,255,255,.18); font-weight:800; }
  button:disabled { opacity:.5; cursor:not-allowed; }
  .small { font-size:12px; opacity:.85; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  .tag { font-size:12px; padding:2px 8px; border-radius:999px; background: rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.12); }
  .coach { align-items:flex-start; }
  .coach b { display:block; margin-bottom:4px; }
  .coach .msg { line-height: 1.35; }
</style>
</head>

<body>
  <div class="wrap">
    <canvas id="cv" width="1000" height="520"></canvas>
  </div>

  <div class="hud">
    <div class="card grow coach">
      <div style="display:flex; gap:10px; align-items:flex-start;">
        <div class="tag" id="dateTag">1å¹´4æœˆä¸Šæ—¬</div>
        <div>
          <b>ç›£ç£ï¼ˆå„ªã—ã„å£èª¿ï¼‰</b>
          <div class="msg" id="coachMsg">å¾…æ©Ÿä¸­ã§ã™ã€‚ã¾ãšã¯ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</div>
          <div class="small" id="eventHint"></div>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <div>
          <b>100mï¼ˆMVPï¼‰</b>
          <div class="small">ã‚¿ãƒƒãƒ—ã§ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆ1å›å‹è² ï¼‰ã€‚ã‚„ã‚Šç›´ã—ã¯ãƒšãƒ¼ã‚¸æ›´æ–°ã€‚</div>
        </div>
      </div>

      <div style="display:flex; gap:10px;">
        <button id="btnStart" style="flex:1;">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="btnNext" class="secondary" style="flex:1;">æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸</button>
      </div>

      <div class="card mono" id="status">å¾…æ©Ÿä¸­</div>
    </div>
  </div>

<script>
/** =========================
 *  æ”¹è‰¯1ï¼šåå‰å…¥åŠ›ï¼‹ä¿å­˜ï¼ˆç¶­æŒï¼‰
 * ========================= */
const STORAGE_KEY_NAME = "sprintDynasty_playerName_v1";
function getPlayerName(){
  let name = (localStorage.getItem(STORAGE_KEY_NAME) || "").trim();
  if (!name){
    name = prompt("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆå¾Œã‹ã‚‰å¤‰æ›´ã§ãã¾ã™ï¼‰", "ã‚±ã‚¤ã‚¹ã‚±") || "";
    name = name.trim();
    if (!name) name = "ã‚ãªãŸ";
    localStorage.setItem(STORAGE_KEY_NAME, name);
  }
  return name;
}
function setPlayerName(name){
  localStorage.setItem(STORAGE_KEY_NAME, String(name || "ã‚ãªãŸ").trim() || "ã‚ãªãŸ");
}
const playerName = getPlayerName();

/** =========================
 *  æ”¹è‰¯2ï¼šã‚¿ãƒ¼ãƒ³é€²è¡Œï¼‹ç›£ç£ã®ä¸€è¨€
 *  - 1ãƒ¶æœˆ=ä¸Šæ—¬/ä¸­æ—¬/ä¸‹æ—¬ã®3ã‚¿ãƒ¼ãƒ³
 *  - å¤§ä¼šã¯ã€Œ3ã‚¿ãƒ¼ãƒ³å‰ã€ã«ç›£ç£ãŒå‘ŠçŸ¥
 * ========================= */
const STORAGE_KEY_TURN = "sprintDynasty_turnIndex_v1";
function getTurnIndex(){
  const v = Number(localStorage.getItem(STORAGE_KEY_TURN) || "0");
  return Number.isFinite(v) ? Math.max(0, Math.floor(v)) : 0;
}
function setTurnIndex(v){
  localStorage.setItem(STORAGE_KEY_TURN, String(Math.max(0, Math.floor(v))));
}
let turnIndex = getTurnIndex(); // 0=start: 1å¹´4æœˆä¸Šæ—¬

// 3å¹´åˆ†ï¼š4æœˆ(é–‹å§‹)ã€œç¿Œã€…å¹´3æœˆ
const MONTHS = ["4æœˆ","5æœˆ","6æœˆ","7æœˆ","8æœˆ","9æœˆ","10æœˆ","11æœˆ","12æœˆ","1æœˆ","2æœˆ","3æœˆ"];
const TERMS  = ["ä¸Šæ—¬","ä¸­æ—¬","ä¸‹æ—¬"];

// index -> (year, month, term)
function getDateLabel(idx){
  const monthNo = Math.floor(idx/3) % 12;
  const termNo  = idx % 3;
  const yearNo  = 1 + Math.floor(Math.floor(idx/3) / 12); // 1ã€œ3
  const ym = MONTHS[monthNo] || "??æœˆ";
  const tt = TERMS[termNo] || "";
  return `${yearNo}å¹´${ym}${tt}`;
}
function isInRange(idx, startIdx, endIdx){ return idx >= startIdx && idx <= endIdx; }

// å¤§ä¼šï¼ˆã‚ãªãŸã®ä»•æ§˜ã‚’åæ˜ ï¼šã‚¢ã‚¸ã‚¢å¤§ä¼šã¯10æœˆä¸­æ—¬ã€œ12æœˆä¸Šæ—¬ã€åˆå®¿æ™‚æœŸã‚‚å¤‰æ›´æ¸ˆï¼‰
function idxOf(yearNo, monthStr, termStr){
  const m = MONTHS.indexOf(monthStr);
  const t = TERMS.indexOf(termStr);
  if (m < 0 || t < 0) return 0;
  const monthFromStart = (yearNo-1)*12 + m; // start=Y1 Apr => m=0
  return monthFromStart*3 + t;
}

// MVPã§ã¯ã€Œé–‹å‚¬ã‚¿ãƒ¼ãƒ³ã€ã ã‘æŒã£ã¦ãŠãï¼ˆå‹æ•—æ¡ä»¶/å‡ºå ´æ ã¯æ¬¡ã®æ”¹è‰¯ã§å®Ÿè£…ï¼‰
const EVENTS = [
  // 1å¹´ï¼šåˆ¤å®šãŒå¿…è¦ãªå¤§ä¼š
  { id:"Y1_Rookie_District", name:"æ–°äººæˆ¦ åœ°åŒºå¤§ä¼š", when: idxOf(1,"8æœˆ","ä¸‹æ—¬") },
  { id:"Y1_Rookie_Pref",     name:"æ–°äººæˆ¦ çœŒå¤§ä¼š",   when: idxOf(1,"9æœˆ","ä¸‹æ—¬") },
  { id:"Y1_Rookie_Block",    name:"æ–°äººæˆ¦ ãƒ–ãƒ­ãƒƒã‚¯å¤§ä¼š", when: idxOf(1,"10æœˆ","ä¸­æ—¬") },

  // 2å¹´ï¼šé«˜ä½“é€£ã€œï¼ˆå‹ã¡ä¸ŠãŒã‚Šã¯æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºï¼‰
  { id:"Y2_Inter_District", name:"é«˜ä½“é€£ åœ°åŒºå¤§ä¼š", when: idxOf(2,"5æœˆ","ä¸­æ—¬") },
  { id:"Y2_Rookie_Pref",    name:"æ–°äººæˆ¦ çœŒå¤§ä¼š",   when: idxOf(2,"9æœˆ","ä¸‹æ—¬") },
  { id:"Y2_Rookie_Block",   name:"æ–°äººæˆ¦ ãƒ–ãƒ­ãƒƒã‚¯å¤§ä¼š", when: idxOf(2,"10æœˆ","ä¸­æ—¬") },

  // 3å¹´ï¼šæœ€çŸ­çµ‚äº†ãŒã‚ã‚‹æœ¬ç·šï¼ˆã“ã“ã‚‚æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã§å‹æ•—å®Ÿè£…ï¼‰
  { id:"Y3_Inter_District", name:"é«˜ä½“é€£ åœ°åŒºå¤§ä¼š", when: idxOf(3,"5æœˆ","ä¸­æ—¬") },
];

// åˆå®¿ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã€‚ä»Šå›ã¯é›°å›²æ°—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘ï¼‰
const CAMP = {
  summer: { name:"å¤å­£åˆå®¿", start: idxOf(1,"7æœˆ","ä¸­æ—¬"), end: idxOf(1,"8æœˆ","ä¸­æ—¬") },
  winter: { name:"å†¬å­£åˆå®¿", start: idxOf(1,"1æœˆ","ä¸­æ—¬"), end: idxOf(1,"2æœˆ","ä¸Šæ—¬") },
};

function getUpcomingEvent(idx){
  // ç›´è¿‘ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä»Šä»¥é™ã§æœ€ã‚‚è¿‘ã„ï¼‰
  const future = EVENTS.filter(e => e.when >= idx).sort((a,b)=>a.when-b.when);
  return future[0] || null;
}

function buildCoachMessage(idx){
  const label = getDateLabel(idx);

  // åˆå®¿ä¸­
  if (isInRange(idx, CAMP.summer.start, CAMP.summer.end)){
    return {
      title: label,
      msg: `ã„ã¾ã¯${CAMP.summer.name}ã§ã™ã€‚æ™®æ®µã‚ˆã‚Šä¼¸ã³ã¾ã™ãŒã€ç–²ã‚ŒãŒæºœã¾ã‚Šã‚„ã™ã„ã§ã™ã‚ˆã€‚`,
      hint: "ï¼ˆåˆå®¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯æ¬¡ã®æ”¹è‰¯ã§å®Ÿè£…ã—ã¾ã™ï¼‰"
    };
  }
  if (isInRange(idx, CAMP.winter.start, CAMP.winter.end)){
    return {
      title: label,
      msg: `ã„ã¾ã¯${CAMP.winter.name}ã§ã™ã€‚å†¬å‘ã‘ã®ç·´ç¿’ã§åœŸå°ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚`,
      hint: "ï¼ˆåˆå®¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯æ¬¡ã®æ”¹è‰¯ã§å®Ÿè£…ã—ã¾ã™ï¼‰"
    };
  }

  // å¤§ä¼š3ã‚¿ãƒ¼ãƒ³å‰å‘ŠçŸ¥
  const soon = EVENTS.find(e => e.when - idx === 3);
  if (soon){
    return {
      title: label,
      msg: `ã‚ã¨3ã‚¿ãƒ¼ãƒ³ã§ã€Œ${soon.name}ã€ã§ã™ã€‚èª¿å­ã‚’ä¸Šã’ã¦ã„ãã¾ã—ã‚‡ã†ã€‚`,
      hint: "ï¼ˆå‡ºå ´åˆ¤å®šã¯æ¬¡ã®æ”¹è‰¯ã§å®Ÿè£…ã—ã¾ã™ï¼šèƒ½åŠ›ã ã‘ã§åˆ¤å®šï¼‰"
    };
  }

  // å¤§ä¼šå½“æ—¥
  const today = EVENTS.find(e => e.when === idx);
  if (today){
    return {
      title: label,
      msg: `ä»Šæ—¥ã¯ã€Œ${today.name}ã€ã§ã™ã€‚è½ã¡ç€ã„ã¦ã€è‡ªåˆ†ã®èµ°ã‚Šã‚’ã—ã¾ã—ã‚‡ã†ã€‚`,
      hint: "ï¼ˆã“ã®MVPã§ã¯â€œå˜ç™ºãƒ¬ãƒ¼ã‚¹â€ã§é›°å›²æ°—ç¢ºèªã—ã¾ã™ï¼‰"
    };
  }

  // é€šå¸¸ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰
  const tips = [
    "ã‚¹ã‚¿ãƒ¼ãƒˆã¨åŠ é€ŸãŒå‹è² ã©ã“ã‚ã§ã™ã€‚åŸºç¤ã‚’ä¸å¯§ã«ã‚„ã‚Šã¾ã—ã‚‡ã†ã€‚",
    "æŠ€è¡“ã‚’ç£¨ãã¨ä¼¸ã³ãŒå®‰å®šã—ã¾ã™ã€‚ç„¦ã‚‰ãšç©ã¿ä¸Šã’ã¾ã—ã‚‡ã†ã€‚",
    "ç­‹åŠ›ã¯å¾ŒåŠã®å¤±é€Ÿã‚’æŠ‘ãˆã¾ã™ã€‚åœŸå°ã‚’ä½œã‚‹ã®ã‚‚å¤§äº‹ã§ã™ã‚ˆã€‚",
    "ç–²ã‚Œã‚’æºœã‚ã™ãã‚‹ã¨ã‚±ã‚¬ã«ç¹‹ãŒã‚Šã¾ã™ã€‚ä¼‘ã‚€å‹‡æ°—ã‚‚å¿…è¦ã§ã™ã€‚",
    "å¤§ä¼šãŒè¿‘ã¥ãã»ã©ã€ã‚„ã‚‹ã“ã¨ã‚’çµã‚‹ã¨å¼·ããªã‚Œã¾ã™ã‚ˆã€‚",
  ];
  const nextEv = getUpcomingEvent(idx);
  const msg = tips[Math.floor(Math.random()*tips.length)];
  const hint = nextEv ? `æ¬¡ã®å¤§ä¼šï¼š${getDateLabel(nextEv.when)}ã€Œ${nextEv.name}ã€` : "æ¬¡ã®å¤§ä¼šã¯æœªå®šã§ã™ã€‚";

  return { title: label, msg, hint };
}

/** ========= Canvas ========= **/
const dateTag = document.getElementById("dateTag");
const coachMsg = document.getElementById("coachMsg");
const eventHint = document.getElementById("eventHint");

const canvas = document.getElementById("cv");
const ctx = canvas.getContext("2d");
const W = canvas.width, H = canvas.height;

const btnStart = document.getElementById("btnStart");
const btnNext  = document.getElementById("btnNext");
const statusEl = document.getElementById("status");

const TRACK = { left: 85, right: 955, top: 92, laneH: 48, lanes: 8, finishX: 920 };
const COLORS = ["#ffd400","#66d9ff","#ff6b6b","#a7ff83","#c792ea","#f78c6c","#89ddff","#f6f7ff"];

let state = "idle"; // idle | running | finished
let t0 = 0;

function rand(min, max) { return min + Math.random()*(max-min); }
function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

function makeStats(base){
  const SPD = clamp(Math.round(base + rand(-4,4)), 20, 99);
  const ACC = clamp(Math.round(base + rand(-4,4)), 20, 99);
  const POW = clamp(Math.round(base + rand(-4,4)), 20, 99);
  const TEC = clamp(Math.round(base + rand(-4,4)), 20, 99);
  const STA = clamp(Math.round(base + rand(-4,4)), 20, 99);
  const MEN = clamp(Math.round(base + rand(-4,4)), 20, 99);
  return {SPD,ACC,POW,TEC,STA,MEN};
}

function buildRunners(){
  const runners = [];
  runners.push({ id:"P001", name:playerName, school:"æ˜¥é¢¨é«˜æ ¡", key:true, portrait:"ğŸ™‚", stats: makeStats(55) });
  runners.push({ id:"R_SAME", name:"é¢¨é–“ è¿…", school:"æ§ãƒ¶å²³é«˜æ ¡", key:true, portrait:"ğŸ˜¼", stats: makeStats(60) });
  runners.push({ id:"BOSS", name:"ä¹æ¡ è’¼çœŸ", school:"å¯Œå£«é«˜æ ¡", key:true, portrait:"ğŸ˜¤", stats: makeStats(62) });

  const mobs = [
    ["ç”°ä¸­ é™¸","åŒ—å²³é«˜æ ¡"],
    ["ä½è—¤ æ‚ çœŸ","å¥¥ç©‚é«˜é«˜æ ¡"],
    ["éˆ´æœ¨ æ¹Š","å¤§é›ªå±±é«˜æ ¡"],
    ["é«˜æ©‹ è“®","ç™½å±±é«˜æ ¡"],
    ["ä¼Šè—¤ éš¼äºº","å¾¡å¶½é«˜æ ¡"],
  ];
  for (const [name,school] of mobs){
    runners.push({ id:"M_"+name, name, school, key:false, portrait:"", stats: makeStats(54) });
  }

  for (let i=runners.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [runners[i], runners[j]] = [runners[j], runners[i]];
  }

  runners.forEach((r,idx)=>{
    r.lane = idx;
    r.y = TRACK.top + idx*TRACK.laneH;
    r.x = TRACK.left;
    r.v = 0;
    r.done = false;
    r.time = null;
    r.animPhase = rand(0, Math.PI*2);
  });

  return runners;
}

let runners = buildRunners();

function calcTargetSpeed(stats){
  const base = 2.05;
  const spd = stats.SPD * 0.026;
  const pow = stats.POW * 0.010;
  return base + spd + pow;
}

function updateRunner(r, dt){
  if (r.done) return;

  const {ACC, TEC, STA, MEN} = r.stats;
  const target = calcTargetSpeed(r.stats);

  const accel = (0.65 + ACC*0.010) * dt;

  const jitterAmp = clamp(0.35 - (MEN*0.002 + TEC*0.001), 0.05, 0.35);
  const jitter = (Math.random()*2-1) * jitterAmp;

  const progress = (r.x - TRACK.left) / (TRACK.finishX - TRACK.left);
  const fade = (progress > 0.65) ? ( (0.65-progress) * ( (80-STA)/140 ) ) : 0;
  const fatigueFactor = clamp(1 + fade, 0.88, 1.02);

  r.v += (target - r.v) * accel;
  const step = (r.v + jitter) * fatigueFactor * 60 * dt;
  r.x += Math.max(0.5, step);

  if (r.x >= TRACK.finishX){
    r.x = TRACK.finishX;
    r.done = true;
    r.time = (performance.now() - t0) / 1000;
  }
}

function allDone(){ return runners.every(r=>r.done); }

function roundRect(x, y, w, h, r, fill, stroke) {
  if (w < 2*r) r = w/2;
  if (h < 2*r) r = h/2;
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y,   x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x,   y+h, r);
  ctx.arcTo(x,   y+h, x,   y,   r);
  ctx.arcTo(x,   y,   x+w, y,   r);
  ctx.closePath();
  if (fill) ctx.fill();
  if (stroke) ctx.stroke();
}

function drawStadiumBg(){
  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0, "#0a1c35");
  g.addColorStop(1, "#081326");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,H);

  ctx.fillStyle = "rgba(255,255,255,.06)";
  ctx.beginPath(); ctx.arc(160, 80, 120, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(840, 70, 140, 0, Math.PI*2); ctx.fill();
}

function drawTrack(){
  drawStadiumBg();

  const pad = 24;
  const trackX = pad, trackY = pad, trackW = W-pad*2, trackH = H-pad*2;
  ctx.fillStyle = "#1d4f9a";
  roundRect(trackX, trackY, trackW, trackH, 18, true, false);

  // è³ªæ„Ÿ
  ctx.save();
  ctx.globalAlpha = 0.08;
  ctx.strokeStyle = "#ffffff";
  ctx.lineWidth = 2;
  for(let x = -H; x < W+H; x += 22){
    ctx.beginPath();
    ctx.moveTo(x, 0);
    ctx.lineTo(x+H, H);
    ctx.stroke();
  }
  ctx.restore();

  // å†…å´
  ctx.fillStyle = "rgba(0,0,0,.18)";
  roundRect(TRACK.left-28, TRACK.top-28, (TRACK.finishX-(TRACK.left-28))+60, TRACK.lanes*TRACK.laneH+56, 16, true, false);

  // ãƒ¬ãƒ¼ãƒ³
  ctx.strokeStyle = "rgba(255,255,255,.42)";
  ctx.lineWidth = 2;
  for (let i=0;i<=TRACK.lanes;i++){
    const y = TRACK.top + i*TRACK.laneH;
    ctx.beginPath();
    ctx.moveTo(TRACK.left, y);
    ctx.lineTo(TRACK.right, y);
    ctx.stroke();
  }

  // ãƒ¬ãƒ¼ãƒ³ç•ªå·
  ctx.fillStyle = "rgba(255,255,255,.75)";
  ctx.font = "700 12px system-ui";
  for(let i=0;i<TRACK.lanes;i++){
    ctx.fillText(String(i+1), TRACK.left-22, TRACK.top + i*TRACK.laneH + 30);
  }

  // ã‚¹ã‚¿ãƒ¼ãƒˆ
  ctx.strokeStyle = "rgba(255,255,255,.92)";
  ctx.lineWidth = 5;
  ctx.beginPath();
  ctx.moveTo(TRACK.left, TRACK.top);
  ctx.lineTo(TRACK.left, TRACK.top + TRACK.lanes*TRACK.laneH);
  ctx.stroke();

  // ã‚´ãƒ¼ãƒ«ï¼ˆå¸‚æ¾ï¼‰
  const fy0 = TRACK.top, fy1 = TRACK.top + TRACK.lanes*TRACK.laneH;
  const block = 10;
  for(let y=fy0; y<fy1; y+=block){
    const on = ((Math.floor((y-fy0)/block)) % 2) === 0;
    ctx.fillStyle = on ? "rgba(255,255,255,.95)" : "rgba(0,0,0,.55)";
    ctx.fillRect(TRACK.finishX, y, 10, block);
  }

  // 100m
  ctx.fillStyle = "rgba(255,255,255,.9)";
  ctx.font = "900 18px system-ui";
  ctx.fillText("100m", TRACK.left, 46);
}

function drawRunnerHuman(r, now){
  const laneColor = COLORS[r.lane % COLORS.length];
  const running = (state === "running") && !r.done;

  const speed01 = clamp(r.v / 4.0, 0.2, 1.0);
  const phase = running ? (now/90 * (0.8 + speed01*1.2) + r.animPhase) : r.animPhase;

  // ï¼ˆã„ã¾ã¯ãƒã‚¦ãƒ³ã‚¹å¼·ã‚ã«ãªã‚ŠãŒã¡ãªã®ã§æ§ãˆã‚ï¼‰
  const bounce = running ? Math.sin(phase) * (1.0 + speed01*0.6) : 0;
  const lean = running ? (0.16 + speed01*0.08) : 0.10;

  const swing = running ? Math.sin(phase) : 0;
  const swing2 = running ? Math.sin(phase + Math.PI/2) : 0;

  const cx = r.x + 12;
  const cy = r.y + 28 + bounce;

  // shadow
  ctx.fillStyle = "rgba(0,0,0,.28)";
  ctx.beginPath();
  ctx.ellipse(cx+4, cy+26, 12 - bounce*0.15, 4 - bounce*0.05, 0, 0, Math.PI*2);
  ctx.fill();

  ctx.save();
  ctx.translate(cx, cy);
  ctx.rotate(-lean);

  // legs
  ctx.strokeStyle = "rgba(0,0,0,.55)";
  ctx.lineWidth = 3.1;
  ctx.lineCap = "round";

  const legSpread = 12 + speed01*6;
  const lf = swing * legSpread;
  const lb = -swing * legSpread;

  ctx.beginPath();
  ctx.moveTo(-2, 12);
  ctx.lineTo(-4 + lf*0.18, 22);
  ctx.lineTo(-6 + lf*0.22, 24 + Math.max(0, -swing)*2);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo( 2, 12);
  ctx.lineTo( 4 + lb*0.18, 22);
  ctx.lineTo( 6 + lb*0.22, 24 + Math.max(0, swing)*2);
  ctx.stroke();

  // torso
  ctx.fillStyle = laneColor;
  roundRect(-9, -4, 18, 20, 5, true, false);

  // bib
  ctx.fillStyle = "rgba(255,255,255,.88)";
  roundRect(-7, 5, 14, 9, 2, true, false);
  ctx.fillStyle = "rgba(0,0,0,.65)";
  ctx.font = "700 9px system-ui";
  ctx.fillText(String(r.lane+1), -2.5, 12);

  // arms
  ctx.strokeStyle = "rgba(0,0,0,.55)";
  ctx.lineWidth = 3.0;

  const armSpread = 16 + speed01*8;
  const a1 = swing2 * armSpread;
  const a2 = -swing2 * armSpread;

  ctx.beginPath();
  ctx.moveTo(-8, 0);
  ctx.lineTo(-14 + a1*0.20, 6 + (-swing2)*2);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo( 8, 0);
  ctx.lineTo( 14 + a2*0.20, 6 + (swing2)*2);
  ctx.stroke();

  // head
  ctx.fillStyle = "rgba(255,255,255,.95)";
  ctx.beginPath();
  ctx.arc(0, -12, 6.2, 0, Math.PI*2);
  ctx.fill();
  ctx.strokeStyle = "rgba(0,0,0,.25)";
  ctx.lineWidth = 1.4;
  ctx.stroke();

  ctx.restore();

  // label
  const labelX = TRACK.finishX + 14;
  const labelY = r.y + 25;

  ctx.fillStyle = "rgba(0,0,0,.55)";
  roundRect(labelX-6, labelY-14, 240, 22, 8, true, false);

  ctx.fillStyle = "#fff";
  ctx.font = "12px system-ui";
  ctx.fillText(`${r.name}ï¼ˆ${r.school}ï¼‰`, labelX, labelY);

  // portrait bubble
  if (r.key){
    const bx = r.x + 40;
    const by = r.y - 10;
    ctx.fillStyle = "rgba(255,255,255,.92)";
    roundRect(bx, by, 44, 30, 8, true, false);
    ctx.beginPath();
    ctx.moveTo(bx+10, by+30);
    ctx.lineTo(bx+18, by+30);
    ctx.lineTo(bx+12, by+38);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle = "#111";
    ctx.font = "20px system-ui";
    ctx.fillText(r.portrait || "ğŸ™‚", bx+10, by+22);
  }
}

function draw(now){
  drawTrack();
  runners.forEach(r => drawRunnerHuman(r, now));

  if (state === "finished"){
    const sorted = [...runners].sort((a,b)=>a.time - b.time);

    ctx.fillStyle = "rgba(0,0,0,.70)";
    roundRect(630, 30, 340, 190, 16, true, false);

    ctx.fillStyle = "#eaf2ff";
    ctx.font = "900 16px system-ui";
    ctx.fillText("çµæœï¼ˆæ±ºå‹ï¼‰", 650, 60);

    ctx.font = "13px system-ui";
    sorted.slice(0,8).forEach((r,i)=>{
      ctx.fillText(`${i+1}ä½  ${r.name}  ${r.time.toFixed(2)}s`, 650, 88 + i*18);
    });

    const win = sorted[0];
    statusEl.textContent = `å¤§ä¼šçµ‚äº†ï¼šå„ªå‹ ${win.name}ï¼ˆ${win.time.toFixed(2)}sï¼‰`;
  }
}

let last = performance.now();
function loop(now){
  const dt = (now - last) / 1000;
  last = now;

  if (state === "running"){
    runners.forEach(r => updateRunner(r, dt));
    if (allDone()){
      state = "finished";
      btnStart.disabled = true;
      btnNext.disabled = false;
    }
  }

  draw(now);
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function refreshCoach(){
  dateTag.textContent = getDateLabel(turnIndex);
  const info = buildCoachMessage(turnIndex);
  coachMsg.textContent = info.msg;
  eventHint.textContent = info.hint || "";
}

function startRace(){
  if (state !== "idle") return;
  state = "running";
  t0 = performance.now();
  btnStart.disabled = true;
  btnNext.disabled = true;
  statusEl.textContent = "ãƒ¬ãƒ¼ã‚¹ä¸­â€¦";
}

function nextTurn(){
  // ã‚¿ãƒ¼ãƒ³é€²è¡Œï¼ˆè‚²æˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯æ¬¡ã®æ”¹è‰¯ã§è¿½åŠ ï¼‰
  turnIndex += 1;
  setTurnIndex(turnIndex);

  // æ¬¡ã‚¿ãƒ¼ãƒ³ã«å…¥ã£ãŸã‚‰â€œæ–°ã—ã„æ—¥â€ã¨ã—ã¦ãƒ¬ãƒ¼ã‚¹ã‚‚ã‚„ã‚Œã‚‹ï¼ˆç·´ç¿’è©¦åˆæ‰±ã„ï¼‰
  // â€»å…¬å¼å¤§ä¼šã®ä»•çµ„ã¿ï¼ˆäºˆé¸/æ±ºå‹/å‡ºå ´åˆ¤å®šï¼‰ã¯æ¬¡ã®æ”¹è‰¯ã§
  state = "idle";
  runners = buildRunners();
  btnStart.disabled = false;
  btnNext.disabled = false;
  statusEl.textContent = "å¾…æ©Ÿä¸­ï¼ˆæ¬¡ã®ã‚¿ãƒ¼ãƒ³ï¼‰";

  refreshCoach();
}

btnStart.addEventListener("click", startRace);
btnNext.addEventListener("click", nextTurn);
canvas.addEventListener("click", ()=>{ if (state === "idle") startRace(); });

// åˆæœŸè¡¨ç¤º
btnNext.disabled = false;
refreshCoach();

/** é–‹ç™ºç”¨ï¼šNã§åå‰å¤‰æ›´ */
window.addEventListener("keydown", (e)=>{
  if (e.key.toLowerCase() === "n"){
    const next = (prompt("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å¤‰æ›´ã—ã¾ã™", localStorage.getItem(STORAGE_KEY_NAME) || playerName) || "").trim();
    if (next){
      setPlayerName(next);
      location.reload();
    }
  }
});
</script>
</body>
</html>
