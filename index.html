<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sprint Dynasty MVP</title>
<style>
  body { margin:0; background:#222; font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; }
  .wrap { display:flex; justify-content:center; padding:18px; }
  canvas { background:#2e8b57; border-radius:12px; box-shadow: 0 8px 24px rgba(0,0,0,.35); }
  .hud {
    max-width:1000px; margin:0 auto; color:#eee; padding:0 18px 18px;
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
  }
  .card {
    background:#111; border:1px solid #333; border-radius:12px;
    padding:10px 12px; display:flex; gap:10px; align-items:center;
  }
  button {
    appearance:none; border:0; border-radius:12px; padding:10px 14px;
    background:#ffd400; color:#111; font-weight:800; cursor:pointer;
  }
  button:disabled { opacity:.5; cursor:not-allowed; }
  .small { font-size:12px; opacity:.85; }
</style>
</head>

<body>
  <div class="wrap">
    <canvas id="cv" width="1000" height="520"></canvas>
  </div>

  <div class="hud">
    <div class="card">
      <div><b>100mï¼ˆMVPï¼‰</b><div class="small">ã‚¿ãƒƒãƒ—ã§ã‚¹ã‚¿ãƒ¼ãƒˆã€‚ã‚‚ã†ä¸€å›ã§ãƒªã‚»ãƒƒãƒˆã€‚</div></div>
    </div>
    <button id="btnStart">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    <button id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>
    <div class="card" id="status">å¾…æ©Ÿä¸­</div>
  </div>

<script>
/** ========= MVP: 8-lane 100m race ========= **/
const canvas = document.getElementById("cv");
const ctx = canvas.getContext("2d");
const W = canvas.width, H = canvas.height;

const btnStart = document.getElementById("btnStart");
const btnReset = document.getElementById("btnReset");
const statusEl = document.getElementById("status");

const TRACK = {
  left: 70,
  right: 950,
  top: 80,
  laneH: 48,
  lanes: 8,
  finishX: 920
};

const COLORS = ["#ffd400","#66d9ff","#ff6b6b","#a7ff83","#c792ea","#f78c6c","#89ddff","#f6f7ff"];

// ä¸»è¦äººç‰©ï¼šå¹ãå‡ºã—ï¼ˆå†™çœŸã®ä»£ã‚ã‚Šã«çµµæ–‡å­—ï¼‰
// å¾Œã§ portrait ã«ç”»åƒURLã‚’å…¥ã‚Œã‚Œã°ã€Œå†™çœŸã£ã½ãã€ã‚‚ã§ãã‚‹
const KEY_IDS = new Set(["P001","R_SAME","BOSS"]);

let state = "idle"; // idle | running | finished
let t0 = 0;

function rand(min, max) { return min + Math.random()*(max-min); }
function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

/** èƒ½åŠ›â†’ã‚¹ãƒ”ãƒ¼ãƒ‰ã¸ã®è¶…ç°¡æ˜“å¼ï¼ˆå¾Œã§ã‚ãªãŸã®ç¢ºå®šå¼ã«å·®ã—æ›¿ãˆã‚‹å‰æï¼‰
 * SPD/ACC/POW/TEC/STA/MEN ã®é›°å›²æ°—ã ã‘å…¥ã‚Œã¦ã‚‹
 */
function makeStats(base){
  const SPD = clamp(Math.round(base + rand(-4,4)), 20, 99);
  const ACC = clamp(Math.round(base + rand(-4,4)), 20, 99);
  const POW = clamp(Math.round(base + rand(-4,4)), 20, 99);
  const TEC = clamp(Math.round(base + rand(-4,4)), 20, 99);
  const STA = clamp(Math.round(base + rand(-4,4)), 20, 99);
  const MEN = clamp(Math.round(base + rand(-4,4)), 20, 99);
  return {SPD,ACC,POW,TEC,STA,MEN};
}

// MVPã®åå‰ï¼ˆå¾Œã§JSONã‹ã‚‰èª­ã‚€ï¼‰
// ä»Šã¯ã€Œãã‚Œã£ã½ã•ã€ã‚’æ„Ÿã˜ã‚‹æœ€ä½é™ã«ã—ã¦ã‚ã‚‹
function buildRunners(){
  const runners = [];

  // ä¸»äººå…¬ï¼ˆé»„è‰²ï¼‰
  runners.push({
    id:"P001",
    name:"ï¼ˆã‚ãªãŸï¼‰",
    school:"æ˜¥é¢¨é«˜æ ¡",
    key:true,
    portrait:"ğŸ™‚",
    stats: makeStats(55)
  });

  // åŒå¹´ä»£ãƒ©ã‚¤ãƒãƒ«ï¼ˆå¼·è±ªæ ¡å›ºå®šï¼‰
  runners.push({
    id:"R_SAME",
    name:"é¢¨é–“ è¿…",
    school:"æ§ãƒ¶å²³é«˜æ ¡",
    key:true,
    portrait:"ğŸ˜¼",
    stats: makeStats(60)
  });

  // å¤§ä¼šãƒœã‚¹ï¼ˆã“ã“ã§ã¯ä»®ã§å…¥ã‚Œã‚‹ï¼‰
  runners.push({
    id:"BOSS",
    name:"ä¹æ¡ è’¼çœŸ",
    school:"å¯Œå£«é«˜æ ¡",
    key:true,
    portrait:"ğŸ˜¤",
    stats: makeStats(62)
  });

  // æ®‹ã‚Šãƒ¢ãƒ–5äºº
  const mobs = [
    ["ç”°ä¸­ é™¸","åŒ—å²³é«˜æ ¡"],
    ["ä½è—¤ æ‚ çœŸ","å¥¥ç©‚é«˜é«˜æ ¡"],
    ["éˆ´æœ¨ æ¹Š","å¤§é›ªå±±é«˜æ ¡"],
    ["é«˜æ©‹ è“®","ç™½å±±é«˜æ ¡"],
    ["ä¼Šè—¤ éš¼äºº","å¾¡å¶½é«˜æ ¡"],
  ];
  for (const [name,school] of mobs){
    runners.push({
      id:"M_"+name,
      name, school,
      key:false,
      portrait:"", // ä¸»è¦ã˜ã‚ƒãªã„ã®ã§ç„¡ã—
      stats: makeStats(54)
    });
  }

  // ãƒ¬ãƒ¼ãƒ³å‰²ã‚Šå½“ã¦ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰
  for (let i=runners.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [runners[i], runners[j]] = [runners[j], runners[i]];
  }

  // ãƒ©ãƒ³ãƒŠãƒ¼çŠ¶æ…‹ã‚’ä»˜ä¸
  runners.forEach((r,idx)=>{
    r.lane = idx;
    r.y = TRACK.top + idx*TRACK.laneH;
    r.x = TRACK.left;
    r.v = 0;
    r.done = false;
    r.time = null;
  });

  return runners;
}

let runners = buildRunners();

function calcTargetSpeed(stats){
  // ã–ã£ãã‚Šï¼šåŸºç¤ + SPD + POWå°‘ã—ã€MEN/TECã§ãƒ–ãƒ¬è€æ€§
  const base = 2.1;
  const spd = stats.SPD * 0.025;
  const pow = stats.POW * 0.010;
  return base + spd + pow; // px/frameï¼ˆå¾Œã§å¼å·®ã—æ›¿ãˆï¼‰
}

function updateRunner(r, dt){
  if (r.done) return;

  const {SPD, ACC, TEC, STA, MEN} = r.stats;
  const target = calcTargetSpeed(r.stats);

  // åŠ é€Ÿï¼šACCãŒé«˜ã„ã»ã©æ—©ãtargetã«è¿‘ã¥ã
  const accel = (0.6 + ACC*0.010) * dt;

  // ãƒ–ãƒ¬ï¼šMEN/TECãŒä½ã„ã»ã©æºã‚Œã‚‹ï¼ˆé‹è¦ç´ ï¼‰
  const jitterAmp = clamp(0.35 - (MEN*0.002 + TEC*0.001), 0.05, 0.35);
  const jitter = (Math.random()*2-1) * jitterAmp;

  // å¾ŒåŠå¤±é€Ÿï¼ˆSTAãŒä½ã„ã¨å°‘ã—å¤±é€Ÿï¼‰
  const progress = (r.x - TRACK.left) / (TRACK.finishX - TRACK.left);
  const fade = (progress > 0.65) ? ( (0.65-progress) * ( (80-STA)/140 ) ) : 0; // ãƒã‚¤ãƒŠã‚¹å¯„ã‚Š
  const fatigueFactor = clamp(1 + fade, 0.88, 1.02);

  // é€Ÿåº¦æ›´æ–°
  r.v += (target - r.v) * accel;
  const step = (r.v + jitter) * fatigueFactor * 60 * dt; // dtç§’â†’ãƒ•ãƒ¬ãƒ¼ãƒ æ›ç®—

  r.x += Math.max(0.5, step);

  if (r.x >= TRACK.finishX){
    r.x = TRACK.finishX;
    r.done = true;
    r.time = (performance.now() - t0) / 1000;
  }
}

function allDone(){
  return runners.every(r=>r.done);
}

function drawTrack(){
  // field
  ctx.fillStyle = "#2e8b57";
  ctx.fillRect(0,0,W,H);

  // lanes
  ctx.strokeStyle = "rgba(255,255,255,.45)";
  ctx.lineWidth = 2;
  for (let i=0;i<=TRACK.lanes;i++){
    const y = TRACK.top + i*TRACK.laneH;
    ctx.beginPath();
    ctx.moveTo(TRACK.left, y);
    ctx.lineTo(TRACK.right, y);
    ctx.stroke();
  }

  // start line
  ctx.strokeStyle = "rgba(255,255,255,.9)";
  ctx.lineWidth = 4;
  ctx.beginPath();
  ctx.moveTo(TRACK.left, TRACK.top);
  ctx.lineTo(TRACK.left, TRACK.top + TRACK.lanes*TRACK.laneH);
  ctx.stroke();

  // finish line
  ctx.strokeStyle = "rgba(255,255,255,.9)";
  ctx.lineWidth = 4;
  ctx.beginPath();
  ctx.moveTo(TRACK.finishX, TRACK.top);
  ctx.lineTo(TRACK.finishX, TRACK.top + TRACK.lanes*TRACK.laneH);
  ctx.stroke();

  // distance label
  ctx.fillStyle = "rgba(255,255,255,.85)";
  ctx.font = "700 16px system-ui";
  ctx.fillText("100m", TRACK.left, 40);
}

function drawRunner(r){
  const x = r.x;
  const y = r.y + 6;
  const w = 18, h = 34;

  // silhouette body
  ctx.fillStyle = COLORS[r.lane % COLORS.length];
  ctx.fillRect(x, y, w, h);

  // name label
  ctx.fillStyle = "rgba(0,0,0,.65)";
  ctx.fillRect(x-4, y-18, 160, 16);
  ctx.fillStyle = "#fff";
  ctx.font = "12px system-ui";
  ctx.fillText(`${r.name}ï¼ˆ${r.school}ï¼‰`, x, y-6);

  // key bubble (portrait)
  if (r.key){
    const bx = x + 30;
    const by = y - 44;
    // bubble
    ctx.fillStyle = "rgba(255,255,255,.92)";
    roundRect(bx, by, 44, 30, 8, true, false);
    // tail
    ctx.beginPath();
    ctx.moveTo(bx+10, by+30);
    ctx.lineTo(bx+18, by+30);
    ctx.lineTo(bx+12, by+38);
    ctx.closePath();
    ctx.fillStyle = "rgba(255,255,255,.92)";
    ctx.fill();

    // portrait (emoji for now)
    ctx.fillStyle = "#111";
    ctx.font = "20px system-ui";
    ctx.fillText(r.portrait || "ğŸ™‚", bx+10, by+22);
  }
}

function roundRect(x, y, w, h, r, fill, stroke) {
  if (w < 2*r) r = w/2;
  if (h < 2*r) r = h/2;
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y,   x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x,   y+h, r);
  ctx.arcTo(x,   y+h, x,   y,   r);
  ctx.arcTo(x,   y,   x+w, y,   r);
  ctx.closePath();
  if (fill) ctx.fill();
  if (stroke) ctx.stroke();
}

function draw(){
  drawTrack();
  runners.forEach(drawRunner);

  // finish results
  if (state === "finished"){
    const sorted = [...runners].sort((a,b)=>a.time - b.time);
    ctx.fillStyle = "rgba(0,0,0,.75)";
    roundRect(640, 25, 330, 180, 14, true, false);
    ctx.fillStyle = "#fff";
    ctx.font = "800 16px system-ui";
    ctx.fillText("çµæœï¼ˆæ±ºå‹ï¼‰", 660, 55);

    ctx.font = "13px system-ui";
    sorted.slice(0,8).forEach((r,i)=>{
      const line = `${i+1}ä½  ${r.name}  ${r.time.toFixed(2)}s`;
      ctx.fillText(line, 660, 80 + i*18);
    });

    const win = sorted[0];
    statusEl.textContent = `å„ªå‹ï¼š${win.name}ï¼ˆ${win.time.toFixed(2)}sï¼‰`;
  }
}

let last = performance.now();
function loop(now){
  const dt = (now - last) / 1000;
  last = now;

  if (state === "running"){
    runners.forEach(r => updateRunner(r, dt));
    if (allDone()){
      state = "finished";
      btnStart.disabled = false;
      btnStart.textContent = "ã‚‚ã†ä¸€å›";
    }
  }

  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function startRace(){
  if (state === "idle"){
    state = "running";
    t0 = performance.now();
    btnStart.disabled = true;
    statusEl.textContent = "ãƒ¬ãƒ¼ã‚¹ä¸­â€¦";
  } else if (state === "finished"){
    resetRace();
    startRace();
  }
}

function resetRace(){
  runners = buildRunners();
  state = "idle";
  btnStart.disabled = false;
  btnStart.textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆ";
  statusEl.textContent = "å¾…æ©Ÿä¸­";
}

btnStart.addEventListener("click", startRace);
btnReset.addEventListener("click", resetRace);

// ç”»é¢ã‚¿ãƒƒãƒ—ã§ã‚‚ã‚¹ã‚¿ãƒ¼ãƒˆ
canvas.addEventListener("click", ()=>{
  if (state === "idle") startRace();
});
</script>
</body>
</html>
